// ========== Global Variables ==========
let cart = JSON.parse(localStorage.getItem('allaf_cart')) || [];
let currentProduct = null;

// ========== DOM Content Loaded ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('🌟 مرحباً بك في مخبزة علاّف المحسنة! نتمنى لك تجربة ممتعة 👨‍🍳');

    initializeWebsite();
    updateCartDisplay();
    setupEventListeners();
    setupScrollAnimations();
    hideLoadingScreen();
    updateVisitorCount(); // ✅ عداد الزوار يعمل الآن
});

// ========== Website Initialization ==========
function initializeWebsite() {
    setupSmoothScrolling();
    setupHeaderScrollEffect();
    setupProductFiltering();
    setupBackToTop();
    setupIntersectionObserver();
}

// ========== Loading Screen ==========
function hideLoadingScreen() {
    setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if (loadingScreen) {
            loadingScreen.classList.add('hidden');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }
    }, 1500);
}

// ========== Smooth Scrolling ==========
function setupSmoothScrolling() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                const headerHeight = document.getElementById('main-header').offsetHeight;
                const targetPosition = target.offsetTop - headerHeight;

                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });

                updateActiveNavLink(this.getAttribute('href'));
                closeMobileMenu();
            }
        });
    });
}

// ========== Header Scroll Effect ==========
function setupHeaderScrollEffect() {
    window.addEventListener('scroll', function() {
        const header = document.getElementById('main-header');
        if (window.scrollY > 100) {
            header.classList.add('scrolled');
        } else {
            header.classList.remove('scrolled');
        }
    });
}

// ========== Navigation ==========
function updateActiveNavLink(href) {
    document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelectorAll(`a[href="${href}"]`).forEach(link => {
        link.classList.add('active');
    });
}

function toggleMobileMenu() {
    const mobileNav = document.getElementById('mobile-nav');
    mobileNav.classList.toggle('active');
}

function closeMobileMenu() {
    const mobileNav = document.getElementById('mobile-nav');
    mobileNav.classList.remove('active');
}

// ========== Product Filtering ==========
function setupProductFiltering() {
    const categoryButtons = document.querySelectorAll('.category-btn');
    const productCards = document.querySelectorAll('.product-card');

    categoryButtons.forEach(button => {
        button.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            categoryButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            filterProducts(category, productCards);
        });
    });
}

function filterProducts(category, productCards) {
    productCards.forEach(card => {
        const productCategory = card.getAttribute('data-category');

        if (category === 'all' || productCategory === category) {
            card.style.display = 'block';
            setTimeout(() => {
                card.classList.remove('hidden');
            }, 100);
        } else {
            card.classList.add('hidden');
            setTimeout(() => {
                card.style.display = 'none';
            }, 300);
        }
    });
}

// ========== Visitor Counter ==========
function updateVisitorCount() {
    const counter = document.getElementById("visitor-count");
    if (!counter) return;

    fetch('https://api.countapi.xyz/hit/allaf-bakery/visits')
        .then(res => res.json())
        .then(data => {
            counter.textContent = data.value;
        })
        .catch(err => {
            console.error("فشل عداد الزوار:", err);
            counter.textContent = "؟";
        });
}

// ========== Cart Display ==========
function updateCartDisplay() {
    const cartCounter = document.getElementById('cart-count');
    if (!cartCounter) return;

    cartCounter.textContent = cart.length;

    const cartItemsContainer = document.getElementById('cart-items');
    if (cartItemsContainer) {
        cartItemsContainer.innerHTML = '';
        cart.forEach((item, index) => {
            const li = document.createElement('li');
            li.textContent = `${item.name} × ${item.quantity}`;
            cartItemsContainer.appendChild(li);
        });
    }
}